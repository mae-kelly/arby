#!/usr/bin/env python3
"""
M1-Optimized Arbitrage Bot - No threading issues
"""

import os
import sys
import asyncio
import time
import logging
from typing import Dict, List
from dataclasses import dataclass

# Simple setup without complex threading
import ccxt.async_support as ccxt
from dotenv import load_dotenv

load_dotenv()

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(message)s'
)
logger = logging.getLogger(__name__)

@dataclass
class Opportunity:
    symbol: str
    buy_exchange: str
    sell_exchange: str
    profit_pct: float

class SimpleBot:
    def __init__(self):
        self.exchanges = {}
        
    async def setup(self):
        """Setup exchanges"""
        
        # Binance
        if os.getenv('BINANCE_API_KEY'):
            self.exchanges['binance'] = ccxt.binance({
                'apiKey': os.getenv('BINANCE_API_KEY'),
                'secret': os.getenv('BINANCE_SECRET'),
                'enableRateLimit': True
            })
            
        # Coinbase
        if os.getenv('COINBASE_API_KEY'):
            self.exchanges['coinbase'] = ccxt.coinbasepro({
                'apiKey': os.getenv('COINBASE_API_KEY'),
                'secret': os.getenv('COINBASE_SECRET'),
                'password': os.getenv('COINBASE_PASSPHRASE'),
                'enableRateLimit': True
            })
            
        # Kraken
        if os.getenv('KRAKEN_API_KEY'):
            self.exchanges['kraken'] = ccxt.kraken({
                'apiKey': os.getenv('KRAKEN_API_KEY'),
                'secret': os.getenv('KRAKEN_SECRET'),
                'enableRateLimit': True
            })
            
        if not self.exchanges:
            logger.error("No exchanges configured!")
            return False
            
        # Load markets
        for name, exchange in self.exchanges.items():
            try:
                await exchange.load_markets()
                logger.info(f"âœ… {name}: {len(exchange.symbols)} markets")
            except Exception as e:
                logger.error(f"âŒ {name}: {e}")
                
        return True
        
    async def find_opportunities(self):
        """Find arbitrage opportunities"""
        
        symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT']
        
        for symbol in symbols:
            prices = {}
            
            # Get prices
            for name, exchange in self.exchanges.items():
                try:
                    if symbol in exchange.symbols:
                        ticker = await exchange.fetch_ticker(symbol)
                        prices[name] = ticker
                except:
                    pass
                    
            # Find arbitrage
            if len(prices) >= 2:
                exchanges = list(prices.keys())
                for i in range(len(exchanges)):
                    for j in range(i+1, len(exchanges)):
                        ex1, ex2 = exchanges[i], exchanges[j]
                        
                        if prices[ex1]['bid'] and prices[ex2]['ask']:
                            profit = (prices[ex1]['bid'] - prices[ex2]['ask']) / prices[ex2]['ask'] * 100
                            if profit > 0.1:
                                logger.info(f"ðŸŽ¯ {symbol}: Buy {ex2} @ ${prices[ex2]['ask']:.2f}, Sell {ex1} @ ${prices[ex1]['bid']:.2f}, Profit: {profit:.3f}%")
                                
                        if prices[ex2]['bid'] and prices[ex1]['ask']:
                            profit = (prices[ex2]['bid'] - prices[ex1]['ask']) / prices[ex1]['ask'] * 100
                            if profit > 0.1:
                                logger.info(f"ðŸŽ¯ {symbol}: Buy {ex1} @ ${prices[ex1]['ask']:.2f}, Sell {ex2} @ ${prices[ex2]['bid']:.2f}, Profit: {profit:.3f}%")
    
    async def run(self):
        """Main loop"""
        
        logger.info("Starting M1 Arbitrage Bot...")
        
        if not await self.setup():
            return
            
        logger.info("Bot running. Press Ctrl+C to stop.\n")
        
        try:
            while True:
                await self.find_opportunities()
                await asyncio.sleep(10)
        except KeyboardInterrupt:
            logger.info("\nStopping...")
            
        # Cleanup
        for exchange in self.exchanges.values():
            await exchange.close()

if __name__ == "__main__":
    bot = SimpleBot()
    asyncio.run(bot.run())
